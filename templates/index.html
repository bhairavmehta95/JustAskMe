<!DOCTYPE HTML>
<html>
<head>
    <title>Flask-SocketIO Test</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            

            var room_ = window.location.pathname.toString();

            room_ = room_.substr(1, room_.length);
            
            // Add old questions:
            // Call API
            // Add them to Queue with timestamps, upvotes (use log.append)
            var DataToSend = new Object();
            DataToSend = {
                namespace : room_
            }

            $.ajax({
                headers: { "Content-Type": "application/json"},
                url: '/api/getRowsChron',
                type: 'POST',
                data: JSON.stringify(DataToSend),
                success: function(data) {
                    obj = JSON.parse(data);

                    // Do something with the result
                    if (obj.questions.length){
                        for (i = 0; i < obj.questions.length; i++) {
                            // TODO: Make this into a function
                            $('.log').append(
                                '<div class = "question"> <br> ' + obj.questions[i] + ' ' + obj.timestamps[i] + ' ' + obj.upvotes[i] +
                                '<button class="up" id="' + obj.questions[i] + '_up"> Up </button> <button class="down" id="' + obj.questions[i] + '_down"> Down </button> <button class ="del" id="' + obj.questions[i] + '_del"> Del </button></div>'
                                 );
                        }
                    }

                    $('div.log').find('div.question').find('button.up').click(function(event){
                        console.log('up!');
                    });

                    $('div.log').find('div.question').find('button.down').click(function(event){
                        console.log('down!');
                    });

                    $('div.log').find('div.question').find('button.del').click(function(event){
                        console.log('deleted');
                    });
                },
                error: function(data, status){
                    return_val = '';
                },
            });




            // Connect to socket
            namespace = '/';
            var socket = io.connect('https://' + document.domain + ':' + location.port + namespace);

            socket.emit('join', {room: room_});

            socket.on('connect', function() {
                socket.emit('my event', {data: 'I\'m connected!'});
            });
            socket.on('disconnect', function() {
                $('.log').append('<br>Disconnected');
            });
            socket.on('my response', function(msg) {
                $('.log').append('<br>Received: ' + msg.data);
            });

            // event handler for server sent data
            // the data is displayed in the "Received" section of the page
            // handlers for the different forms in the page
            // these send data to the server in a variety of ways

            $('form#emit').submit(function(event) {
                socket.emit('my event', {data: $('#emit_data').val()});
                return false;
            });
            $('form#send_room').submit(function(event) {
                socket.emit('my room event', {room: room_, data: $('#room_data').val()});
                return false;
            });
            $('form#close').submit(function(event) {
                socket.emit('close room', {room: $('#close_room').val()});
                return false;
            });
            $('form#disconnect').submit(function(event) {
                socket.emit('disconnect request');
                return false;
            });

        });

        $(document).ready( function() {
            $('#sort_chron').click(function(){
                room = window.location.pathname.toString();

                room = room.substr(1, room.length);
            
                
                var DataToSend = new Object();
                DataToSend = {
                    namespace : room
                }

                $.ajax({
                    headers: { "Content-Type": "application/json"},
                    url: '/api/getRowsChron',
                    type: 'POST',
                    data: JSON.stringify(DataToSend),
                    success: function(data) {
                        obj = JSON.parse(data);
                        
                        $(".log").empty();
                        console.log('emptied div, refilling with chronological data');

                        // Do something with the result
                        if (obj.questions.length){
                            for (i = 0; i < obj.questions.length; i++) {
                                // TODO: Make this into a function
                                $('.log').append(
                                    '<div class = "question"> <br> ' + obj.questions[i] + ' ' + obj.timestamps[i] + ' ' + obj.upvotes[i] +
                                    '<button class="up" id="' + obj.questions[i] + '_up"> Up </button> <button class="down" id="' + obj.questions[i] + '_down"> Down </button> <button class ="del" id="' + obj.questions[i] + '_del"> Del </button></div>'
                                     );
                            }
                        }
                    },
                    error: function(data, status){
                        return_val = '';
                    },
                });
            });

            $('#sort_top').click(function(){
                room = window.location.pathname.toString();

                room = room.substr(1, room.length);
            
                
                var DataToSend = new Object();
                DataToSend = {
                    namespace : room
                }

                $.ajax({
                    headers: { "Content-Type": "application/json"},
                    url: '/api/getRowsChron',
                    type: 'POST',
                    data: JSON.stringify(DataToSend),
                    success: function(data) {
                        obj = JSON.parse(data);
                        
                        $(".log").empty();
                        console.log('emptied div, refilling with top');

                        // Do something with the result
                        if (obj.questions.length){
                            for (i = 0; i < obj.questions.length; i++) {
                                // TODO: Make this into a function
                                $('.log').append(
                                    '<div class = "question"> <br> ' + obj.questions[i] + ' ' + obj.timestamps[i] + ' ' + obj.upvotes[i] +
                                    '<button class="up" id="' + obj.questions[i] + '_up"> Up </button> <button class="down" id="' + obj.questions[i] + '_down"> Down </button> <button class ="del" id="' + obj.questions[i] + '_del"> Del </button></div>'
                                     );
                            }
                        }
                    },
                    error: function(data, status){
                        return_val = '';
                    },
                });
            });


         });
        






        // $('.upvote').click(function(){
        //     $.post("/api/path/to/upvote", function(data){
        //         // Get question id
        //         // POST question id only to api
        //     });
        // });

    </script>
</head>
<body>
    <h1>Flask-SocketIO Test</h1>
    <h2>Send:</h2>

    <button id="sort_chron"> Newest </button>
    <button id="sort_top"> Top </button>

    <form id="send_room" method="POST" action='#'>
        <input type="text" name="room_data" id="room_data" placeholder="Message">
        <input type="submit" value="Send to Room">
    </form>

    <h2>Receive:</h2>
    <div class ='log'> </div>
</body>
</html>
